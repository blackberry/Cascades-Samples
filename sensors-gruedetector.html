<?xml version="1.0" encoding="ISO-8859-1"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<!-- gruedetector.qdoc -->
  <title>Cascades : Grue Detector Example</title>
  <link rel="stylesheet" type="text/css" href="style/offline.css" />
</head>
<body>
<div class="header" id="qtdocheader">
  <div class="content"> 
    <a href="index.html" class="qtref"><span>Qt-based BB10 API Examples Documentation</span></a>
  </div>
  <div class="breadcrumb toolblock">
    <ul>
      <li class="first"><a href="index.html">Home</a></li>
      <!--  Breadcrumbs go here -->
    </ul>
  </div>
</div>
<div class="content mainContent">
<div class="toc">
<h3><a name="toc">Contents</a></h3>
<ul>
<li class="level1"><a href="#description">Description</a></li>
<li class="level1"><a href="#overview">Overview</a></li>
<li class="level1"><a href="#the-ui">The UI</a></li>
<li class="level1"><a href="#gruedetector">GrueDetector</a></li>
</ul>
</div>
<h1 class="title">Grue Detector Example</h1>
<span class="subtitle"></span>
<!-- $$$sensors/gruedetector-description -->
<div class="descr"> <a name="details"></a>
<p>Files:</p>
<ul>
<li><a href="sensors-gruedetector-assets-eye-qml.html">sensors/gruedetector/assets/Eye.qml</a></li>
<li><a href="sensors-gruedetector-assets-grue-qml.html">sensors/gruedetector/assets/Grue.qml</a></li>
<li><a href="sensors-gruedetector-assets-main-qml.html">sensors/gruedetector/assets/main.qml</a></li>
<li><a href="sensors-gruedetector-src-gruedetector-cpp.html">sensors/gruedetector/src/GrueDetector.cpp</a></li>
<li><a href="sensors-gruedetector-src-gruedetector-hpp.html">sensors/gruedetector/src/GrueDetector.hpp</a></li>
<li><a href="sensors-gruedetector-src-main-cpp.html">sensors/gruedetector/src/main.cpp</a></li>
<li><a href="sensors-gruedetector-gruedetector-pro.html">sensors/gruedetector/gruedetector.pro</a></li>
<li><a href="sensors-gruedetector-translations-gruedetector-pro.html">sensors/gruedetector/translations/gruedetector.pro</a></li>
</ul>
<a name="description"></a>
<h2>Description</h2>
<p>The Grue Detector example demonstrates how to use sensors from the QtSensors module to warn you about the chance of being eaten by a Grue.</p>
<p class="centerAlign"><img src="images/gruedetector-example.png" alt="" /></p><a name="overview"></a>
<h2>Overview</h2>
<p>In this example we'll learn how to use the QLightSensor, QLightFilter and QLightReading classes to retrieve the current LUX value from the light sensor of the device. If we are below a given threshold, we'll start a timer and increase the chance of being eaten every second.</p>
<a name="the-ui"></a>
<h2>The UI</h2>
<p>The UI of this sample application consists of an <tt>ImageView</tt> that shows the grue and a <tt>Label</tt> that shows a status message.</p>
<p>The business logic of the application is encapsulated in the GrueDetector class which is made available to the UI under the name '_detector'.</p>
<pre class="qml">                <span class="type">Grue</span> {
                    <span class="name">horizontalAlignment</span>: <span class="name">HorizontalAlignment</span>.<span class="name">Center</span>
                    <span class="name">verticalAlignment</span>: <span class="name">VerticalAlignment</span>.<span class="name">Center</span>
                    <span class="name">scaleX</span>: <span class="name">_detector</span>.<span class="name">chance</span><span class="operator">/</span><span class="number">100</span>
                    <span class="name">scaleY</span>: <span class="name">_detector</span>.<span class="name">chance</span><span class="operator">/</span><span class="number">100</span>

                    <span class="name">chance</span>: <span class="name">_detector</span>.<span class="name">chance</span>
                }</pre>
<p>The UI of the Grue (the eyes and the mouth) are put into a separated file Grue.qml, which we use in main.qml. Depending on the chance of being eaten, we scale up/down the Grue component. If the chance is low, the grue is small, if the chance is high, the grue is large.</p>
<pre class="qml">                <span class="type">Label</span> {
                    <span class="name">horizontalAlignment</span>: <span class="name">HorizontalAlignment</span>.<span class="name">Center</span>
                    <span class="name">verticalAlignment</span>: <span class="name">VerticalAlignment</span>.<span class="name">Bottom</span>
                    <span class="name">text</span>: <span class="name">_detector</span>.<span class="name">chance</span> <span class="operator">&gt;</span> <span class="number">90</span> ? <span class="name">qsTr</span> (<span class="string">&quot;Time to run!&quot;</span>)
                                                : <span class="name">qsTr</span> (<span class="string">&quot;Chance to be eaten at %1%&quot;</span>).<span class="name">arg</span>(<span class="name">_detector</span>.<span class="name">chance</span>)
                    <span class="type">textStyle</span> {
                        <span class="name">base</span>: <span class="name">SystemDefaults</span>.<span class="name">TextStyles</span>.<span class="name">BigText</span>
                        <span class="name">color</span>: <span class="name">Color</span>.<span class="name">White</span>
                    }
                }</pre>
<p>The status label shows the current numeric chance value or a warning message if the chance is too high.</p>
<a name="gruedetector"></a>
<h2>GrueDetector</h2>
<p>The <tt>GrueDetector</tt> class encapsulates the business logic of the application. It contains a QLightSensor object, which does the low-level communication with the light sensor of the device, and provides a property 'chance' to make the calculated chance value available to the UI. It inherits from QCompassFilter and reimplements the 'bool filter(QLightReading*)' method to retrieve the sensor data from the QLightSensor object.</p>
<pre class="cpp">    <span class="keyword">class</span> GrueDetector : <span class="keyword">public</span> <span class="type">QObject</span><span class="operator">,</span> <span class="keyword">public</span> <span class="type">QLightFilter</span>
    {
        Q_OBJECT

        <span class="comment">// The property to access the chance value of being eaten by a grue</span>
        Q_PROPERTY(<span class="type">int</span> chance READ chance NOTIFY chanceChanged)

    <span class="keyword">public</span>:
        GrueDetector(<span class="type">QObject</span> <span class="operator">*</span>parent <span class="operator">=</span> <span class="number">0</span>);

    Q_SIGNALS:
        <span class="comment">// The change notification signal of the chance property</span>
        <span class="type">void</span> chanceChanged();

    <span class="keyword">protected</span>:
        <span class="comment">/**
         * This method is reimplemented from the QLightFilter interface and is
         * called by the QLightSensor whenever new values are available.
         */</span>
        <span class="type">bool</span> filter(<span class="type">QLightReading</span> <span class="operator">*</span>reading);

    <span class="keyword">private</span> Q_SLOTS:
        <span class="comment">// This method is called every second if we are in an dark environment</span>
        <span class="type">void</span> increaseChance();

    <span class="keyword">private</span>:
        <span class="comment">// The accessor method for the chance property</span>
        <span class="type">int</span> chance() <span class="keyword">const</span>;

        <span class="comment">// The value of the chance property</span>
        <span class="type">int</span> m_chance;

        <span class="comment">// The light sensor</span>
        <span class="type">QLightSensor</span> m_sensor;

        <span class="comment">// A timer to calculate the chance</span>
        <span class="type">QTimer</span> <span class="operator">*</span>m_darkTimer;
    };</pre>
<p>Inside the constructor we try to connect the QLightSensor object to the hardware backend. If that's successful, we register the GrueDetector class as filter for the QLightSensor object and start the sensor to gather data.</p>
<pre class="cpp">    GrueDetector<span class="operator">::</span>GrueDetector(<span class="type">QObject</span> <span class="operator">*</span>parent)
        : <span class="type">QObject</span>(parent)
        <span class="operator">,</span> m_chance(<span class="number">0</span>)
        <span class="operator">,</span> m_darkTimer(<span class="keyword">new</span> <span class="type">QTimer</span>(<span class="keyword">this</span>))
    {
        <span class="comment">// At first we have to connect to the sensor backend...</span>
        <span class="keyword">if</span> (<span class="operator">!</span>m_sensor<span class="operator">.</span>connectToBackend()) {
            qWarning() <span class="operator">&lt;</span><span class="operator">&lt;</span> <span class="string">&quot;Cannot connect to light sensor backend!&quot;</span>;
        }

        <span class="comment">// ... and then add a filter that will process the reported data</span>
        m_sensor<span class="operator">.</span>addFilter(<span class="keyword">this</span>);

        <span class="comment">// Start the gathering of data</span>
        m_sensor<span class="operator">.</span>start();

        connect(m_darkTimer<span class="operator">,</span> SIGNAL(timeout())<span class="operator">,</span> <span class="keyword">this</span><span class="operator">,</span> SLOT(increaseChance()));
    }</pre>
<p>The 'bool filter(QLightReading*)' method is called whenever the QLightSensor object retrieved new data from the hardware sensor. Inside this method we check whether the current LUX value is smaller than 100. In this case it's dark around us, so we start a timer that increases the chance value every second by 10%. If the LUX value is larger than 100, we reset the chance value back to 0%.</p>
<pre class="cpp">    <span class="type">bool</span> GrueDetector<span class="operator">::</span>filter(<span class="type">QLightReading</span> <span class="operator">*</span>reading)
    {
        <span class="keyword">if</span> (reading<span class="operator">-</span><span class="operator">&gt;</span>lux() <span class="operator">&lt;</span> <span class="number">100</span>) { <span class="comment">// Dark enough for meeting a Grue</span>
            <span class="keyword">if</span> (<span class="operator">!</span>m_darkTimer<span class="operator">-</span><span class="operator">&gt;</span>isActive())
                m_darkTimer<span class="operator">-</span><span class="operator">&gt;</span>start(<span class="number">1000</span>);
        } <span class="keyword">else</span> { <span class="comment">// everything is fine...</span>
            m_darkTimer<span class="operator">-</span><span class="operator">&gt;</span>stop();
            m_chance <span class="operator">=</span> <span class="number">0</span>;
            <span class="keyword">emit</span> chanceChanged();
        }

        <span class="comment">// Do no further processing of the sensor data</span>
        <span class="keyword">return</span> <span class="keyword">false</span>;
    }</pre>
</div>
<!-- @@@sensors/gruedetector -->
  <div class="ft">
    <span></span>
  </div>
</div> 
<div class="footer">
  <p>
     Copyright 2012 Research In Motion Limited.
  <br />
    This document may be used under the terms of the <a href="http://www.gnu.org/licenses/fdl.html">GNU
    Free Documentation License version 1.3</a>
    as published by the Free Software Foundation.</p>
</div>
</body>
</html>
